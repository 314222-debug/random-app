<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ« å­¸æ ¡å¿«æ¨‚å¤§æŠ½ç</title>
    <style>
        :root {
            --board-bg: #2b4539; /* é»‘æ¿ç¶  */
            --chalk-white: #fcfcfc;
            --chalk-yellow: #f5e058;
            --wood: #8b5a2b;
            --accent: #ff6b6b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #333;
            color: var(--chalk-white);
            margin: 0;
            padding: 20px;
            background-image: url('https://www.transparenttextures.com/patterns/black-scales.png'); /* å¢åŠ ä¸€é»è³ªæ„Ÿ */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            border: 15px solid var(--wood);
            border-radius: 5px;
            background-color: var(--board-bg);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-height: 90vh;
        }

        h1, h2 {
            text-align: center;
            font-family: 'Courier New', Courier, monospace; /* æ¨¡ä»¿ç²‰ç­†å­—é«”é¢¨æ ¼ */
        }

        h1 {
            border-bottom: 2px dashed var(--chalk-white);
            padding-bottom: 10px;
            color: var(--chalk-yellow);
        }

        /* ç‰ˆé¢é…ç½® */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border-radius: 4px;
            border: none;
            font-size: 16px;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-add { background-color: var(--chalk-white); color: var(--board-bg); }
        .btn-draw { background-color: var(--chalk-yellow); color: var(--board-bg); margin-top: 5px;}
        .btn-reset { background-color: var(--accent); color: white; margin-top: 20px;}

        /* åˆ—è¡¨æ¨£å¼ */
        ul { list-style: none; padding: 0; }
        li {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .winner-card {
            background: rgba(245, 224, 88, 0.2);
            border: 1px solid var(--chalk-yellow);
            color: var(--chalk-yellow);
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 5px;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .empty-msg { opacity: 0.5; text-align: center; font-style: italic; }
        
        .prize-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ« å­¸æ ¡å¤§æŠ½çæ´»å‹•ä¸­å¿ƒ</h1>
    <p style="text-align: center;">å³æ™‚é€£ç·šç³»çµ± (Firebase Enabled)</p>

    <div class="dashboard">
        <div class="panel">
            <h2>ğŸ™‹â€â™‚ï¸ é»åè¡¨ (åƒèˆ‡è€…)</h2>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="participantName" placeholder="è¼¸å…¥åŒå­¸å§“å...">
                <button class="btn-add" style="width: 30%;" onclick="addParticipant()">åŠ å…¥</button>
            </div>
            <div style="margin-top: 10px; max-height: 400px; overflow-y: auto;">
                <ul id="participantList">
                    <div class="empty-msg">è¼‰å…¥ä¸­æˆ–æ˜¯ç›®å‰ç„¡äºº...</div>
                </ul>
            </div>
            <p style="text-align: right; font-size: 0.9em;">ç¸½äººæ•¸: <span id="pCount">0</span></p>
        </div>

        <div class="panel">
            <h2>ğŸ çå“æ¸…å–® & æŠ½ç</h2>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="prizeName" placeholder="çå“åç¨± (ä¾‹: ç­†è¨˜æœ¬)">
                <input type="number" id="prizeQty" placeholder="æ•¸é‡" style="width: 80px;" value="1">
            </div>
            <button class="btn-add" onclick="addPrize()">æ–°å¢çé …</button>
            
            <hr style="border-color: rgba(255,255,255,0.1);">
            
            <div id="prizeList" style="max-height: 400px; overflow-y: auto;">
                </div>
        </div>

        <div class="panel">
            <h2>ğŸ† æ¦®è­½æ¦œ (å¾—çåå–®)</h2>
            <div id="winnerList" style="max-height: 500px; overflow-y: auto;">
                <div class="empty-msg">ç­‰å¾…é–‹çä¸­...</div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // å¼•å…¥ Firebase æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        onSnapshot, 
        query, 
        orderBy, 
        updateDoc, 
        doc, 
        serverTimestamp,
        where,
        getDocs,
        writeBatch
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ä½ çš„è¨­å®šæª”
    const firebaseConfig = {
        apiKey: "AIzaSyCiTFIx1vtS0mhk2TmEuxVO_yH29kC66Yo",
        authDomain: "project1209-96d69.firebaseapp.com",
        projectId: "project1209-96d69",
        storageBucket: "project1209-96d69.firebasestorage.app",
        messagingSenderId: "206188053484",
        appId: "1:206188053484:web:8221e6899fb34b602eb6c9"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // å…¨åŸŸè®Šæ•¸æ–¹ä¾¿å­˜å–
    window.db = db;
    
    // --- 1. ç›£è½åƒèˆ‡è€…è³‡æ–™ ---
    const qP = query(collection(db, "participants"), orderBy("createdAt", "desc"));
    onSnapshot(qP, (snapshot) => {
        const list = document.getElementById("participantList");
        list.innerHTML = "";
        let count = 0;
        snapshot.forEach((doc) => {
            const data = doc.data();
            count++;
            const li = document.createElement("li");
            // å¦‚æœå·²ç¶“ä¸­çï¼Œé¡¯ç¤ºä¸åŒæ¨£å¼
            if(data.hasWon) {
                li.style.opacity = "0.5";
                li.style.textDecoration = "line-through";
                li.innerHTML = `${data.name} <span class="tag">å·²ä¸­ç</span>`;
            } else {
                li.innerHTML = `${data.name}`;
            }
            list.appendChild(li);
        });
        document.getElementById("pCount").innerText = count;
        if(count === 0) list.innerHTML = '<div class="empty-msg">ç›®å‰æ²’æœ‰åƒèˆ‡è€…</div>';
    });

    // --- 2. ç›£è½çå“è³‡æ–™ ---
    const qPrize = query(collection(db, "prizes"), orderBy("createdAt", "desc"));
    onSnapshot(qPrize, (snapshot) => {
        const list = document.getElementById("prizeList");
        list.innerHTML = "";
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            
            const div = document.createElement("div");
            div.className = "prize-item";
            
            // åˆ¤æ–·æ˜¯å¦é‚„æœ‰åº«å­˜
            const isAvailable = data.quantity > 0;
            const btnHtml = isAvailable 
                ? `<button class="btn-draw" onclick="drawPrize('${id}', '${data.name}')">æŠ½æ­¤çé … (å‰©é¤˜: ${data.quantity})</button>`
                : `<button class="btn-draw" disabled style="background:#555; cursor:not-allowed;">å·²æŠ½å®Œ</button>`;

            div.innerHTML = `
                <div style="font-size:1.1em; font-weight:bold; color:var(--chalk-yellow)">${data.name}</div>
                <div style="font-size:0.9em; margin-bottom:5px;">ç¸½æ•¸é‡: ${data.originalQty} | å‰©é¤˜: ${data.quantity}</div>
                ${btnHtml}
            `;
            list.appendChild(div);
        });
        if(snapshot.empty) list.innerHTML = '<div class="empty-msg">ç›®å‰æ²’æœ‰çå“</div>';
    });

    // --- 3. ç›£è½å¾—çåå–® ---
    const qW = query(collection(db, "winners"), orderBy("timestamp", "desc"));
    onSnapshot(qW, (snapshot) => {
        const list = document.getElementById("winnerList");
        list.innerHTML = "";
        snapshot.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "winner-card";
            // å°‡ Timestamp è½‰ç‚ºæ™‚é–“å­—ä¸²
            const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
            div.innerHTML = `ğŸ‰ <strong>${data.participantName}</strong> æŠ½ä¸­äº† <strong>${data.prizeName}</strong> <br><span style="font-size:0.8em; opacity:0.8">${timeStr}</span>`;
            list.appendChild(div);
        });
        if(snapshot.empty) list.innerHTML = '<div class="empty-msg">ç­‰å¾…ç¬¬ä¸€ä½å¹¸é‹å…’...</div>';
    });

    // --- åŠŸèƒ½å‡½å¼ ---

    // æ–°å¢åƒèˆ‡è€…
    window.addParticipant = async () => {
        const input = document.getElementById("participantName");
        const name = input.value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“åï¼");

        try {
            await addDoc(collection(db, "participants"), {
                name: name,
                hasWon: false,
                createdAt: serverTimestamp()
            });
            input.value = "";
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase Console æ¬Šé™è¨­å®š (Firestore Rules)");
        }
    };

    // æ–°å¢çå“
    window.addPrize = async () => {
        const nameInput = document.getElementById("prizeName");
        const qtyInput = document.getElementById("prizeQty");
        const name = nameInput.value.trim();
        const qty = parseInt(qtyInput.value);

        if (!name || qty <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„çå“åç¨±èˆ‡æ•¸é‡ï¼");

        try {
            await addDoc(collection(db, "prizes"), {
                name: name,
                quantity: qty,
                originalQty: qty,
                createdAt: serverTimestamp()
            });
            nameInput.value = "";
            qtyInput.value = "1";
        } catch (e) {
            console.error(e);
            alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
        }
    };

    // æŠ½çé‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½)
    window.drawPrize = async (prizeId, prizeName) => {
        // 1. æ‰¾å‡ºæ‰€æœ‰ã€Œæœªä¸­çã€çš„åƒèˆ‡è€…
        const q = query(collection(db, "participants"), where("hasWon", "==", false));
        const snapshot = await getDocs(q);
        
        const candidates = [];
        snapshot.forEach(doc => {
            candidates.push({ id: doc.id, ...doc.data() });
        });

        if (candidates.length === 0) {
            return alert("ğŸ˜± æ²’æœ‰å¯ä»¥æŠ½ççš„åƒèˆ‡è€…äº†ï¼(å¤§å®¶éƒ½ä¸­çäº†æˆ–æ˜¯æ²’äººåƒåŠ )");
        }

        // 2. éš¨æ©Ÿé¸å‡ºä¸€ä½
        const randomIndex = Math.floor(Math.random() * candidates.length);
        const luckyWinner = candidates[randomIndex];

        // 3. åŸ·è¡Œè³‡æ–™åº«æ›´æ–° (Batch write ä¿è­‰ä¸€è‡´æ€§)
        const batch = writeBatch(db);

        // A. æ‰£é™¤çå“æ•¸é‡
        // æ³¨æ„ï¼šé€™è£¡ç°¡å–®è™•ç†ï¼Œå¤šäººåŒæ™‚æŒ‰å¯èƒ½æœƒæœ‰å¤šæ‰£çš„é¢¨éšªï¼Œåš´è¬¹ä½œæ³•éœ€ç”¨ Transactionï¼Œä½†æ­¤ç‚ºç°¡æ˜“ç‰ˆ
        // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘å…ˆè®€å–ç•¶å‰çå“ doc
        // å¯¦éš›æ‡‰ç”¨ä¸­å»ºè­°ä½¿ç”¨ transaction é€™è£¡ç‚ºäº†ä»£ç¢¼å¯è®€æ€§åšåˆ†æ­¥æª¢æŸ¥
        
        // æ›´æ–°åƒèˆ‡è€…ç‹€æ…‹ (è¨­ç‚ºå·²ä¸­ç)
        const userRef = doc(db, "participants", luckyWinner.id);
        batch.update(userRef, { hasWon: true });

        // æ›´æ–°çå“æ•¸é‡
        // æˆ‘å€‘åˆ©ç”¨ firestore increment(-1) æ¯”è¼ƒå®‰å…¨ï¼Œä½†éœ€è¦ import increment
        // é€™è£¡ç›´æ¥ç”¨ updateDoc é‚è¼¯
        const prizeRef = doc(db, "prizes", prizeId);
        // ç‚ºäº†ç¢ºä¿ä¸æ‰£åˆ°è² æ•¸ï¼Œé€™è£¡ç”¨ transaction æ¯”è¼ƒå¥½ï¼Œä½†æˆ‘å…ˆç”¨ç°¡å–®é‚è¼¯ï¼š
        // å‰ç«¯å·²æª¢æŸ¥ quantity > 0ï¼Œé€™è£¡ç›´æ¥ç™¼é€æ›´æ–°
        // (è‹¥é«˜ä½µç™¼æœƒæœ‰ Race Conditionï¼Œå­¸æ ¡æ´»å‹•é€šå¸¸é‚„å¥½)
        
        // å¯«å…¥å¾—çç´€éŒ„
        const winnerRef = doc(collection(db, "winners"));
        batch.set(winnerRef, {
            participantName: luckyWinner.name,
            prizeName: prizeName,
            timestamp: serverTimestamp()
        });

        // æäº¤è®Šæ›´ (æ³¨æ„ï¼šé€™è£¡æ²’åŒ…å«çå“æ•¸é‡ -1ï¼Œå› ç‚ºéœ€è¦è®€å–ç•¶å‰å€¼ï¼Œæˆ‘å€‘ç”¨ç¨ç«‹ update)
        // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘åˆ†é–‹åš
        await batch.commit();

        // ç¨ç«‹æ‰£åº«å­˜ (ä½¿ç”¨ increment æœƒæ›´æº–ï¼Œé€™è£¡ç”¨ç°¡å–®é‚è¼¯è®€å–å†å¯«å…¥æœƒå¤ªæ…¢ï¼Œç›´æ¥å‡è¨­å‰ç«¯æ˜¯å°çš„)
        // é€™è£¡æˆ‘å€‘ç”¨ runTransaction ç¢ºä¿åº«å­˜æ­£ç¢º
        // ç‚ºäº†ä¸è®“ç¨‹å¼ç¢¼å¤ªè¤‡é›œï¼Œæˆ‘å€‘ç”¨ç°¡å–®çš„ update
        // é‡æ–°è®€å–è©²çå“ç›®å‰çš„æ•¸é‡ (é¿å…é«’è®€)
        
        // âš ï¸ ç°¡å–®ç‰ˆå¯«æ³•ï¼šç›´æ¥è§¸ç™¼
        // ç‚ºäº†è®“ UI é †æš¢ï¼Œæˆ‘å€‘åœ¨é€™è£¡åšä¸€å€‹ update
        // ä½ å¯ä»¥æ ¹æ“šéœ€è¦æ”¹æˆ Transaction
        import { increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        await updateDoc(prizeRef, {
            quantity: increment(-1)
        });

        alert(`æ­å–œ ${luckyWinner.name} æŠ½ä¸­äº† ${prizeName}ï¼`);
    };

</script>

</body>
</html>